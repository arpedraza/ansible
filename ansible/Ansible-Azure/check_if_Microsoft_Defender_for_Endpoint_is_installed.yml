---
- name: Check if Microsoft Defender for Endpoint (mdatp) is installed
  hosts: all
  gather_facts: true
  become: true

  tasks:
    - name: Check if mdatp binary exists
      ansible.builtin.stat:
        path: /opt/microsoft/mdatp/sbin/mdatp
      register: mdatp_bin

    - name: Check RPM package (RHEL-style)
      ansible.builtin.shell: "rpm -q mdatp"
      register: rpm_check
      changed_when: false
      failed_when: false
      when: ansible_facts.os_family == "RedHat"

    - name: Check DEB package (Debian/Ubuntu-style)
      ansible.builtin.shell: "dpkg-query -W -f='${Status}' mdatp 2>/dev/null"
      register: dpkg_check
      changed_when: false
      failed_when: false
      when: ansible_facts.os_family == "Debian"

    - name: Check systemd service status (mdatp)
      ansible.builtin.shell: "systemctl is-enabled mdatp 2>/dev/null; systemctl is-active mdatp 2>/dev/null"
      register: svc_check
      changed_when: false
      failed_when: false

    - name: Determine install status
      ansible.builtin.set_fact:
        mdatp_installed: >-
          {{
            mdatp_bin.stat.exists
            or (ansible_facts.os_family == "RedHat" and rpm_check.rc == 0)
            or (ansible_facts.os_family == "Debian" and ('install ok installed' in (dpkg_check.stdout | lower)))
          }}

    - name: Print result per host
      ansible.builtin.debug:
        msg:
          host: "{{ inventory_hostname }}"
          os_family: "{{ ansible_facts.os_family }}"
          mdatp_binary_present: "{{ mdatp_bin.stat.exists }}"
          rpm_query: "{{ (rpm_check.stdout | default('n/a')) if ansible_facts.os_family == 'RedHat' else 'n/a' }}"
          dpkg_query: "{{ (dpkg_check.stdout | default('n/a')) if ansible_facts.os_family == 'Debian' else 'n/a' }}"
          systemd_check: "{{ svc_check.stdout_lines | default([]) }}"
          mdatp_installed: "{{ mdatp_installed }}"

    # Optional: if installed, show health summary (won't fail if not healthy)
    - name: If installed, show mdatp health (short)
      ansible.builtin.command: /opt/microsoft/mdatp/sbin/mdatp health
      register: mdatp_health
      changed_when: false
      failed_when: false
      when: mdatp_installed

    - name: Print mdatp health output (if available)
      ansible.builtin.debug:
        var: mdatp_health.stdout_lines
      when: mdatp_installed and (mdatp_health.stdout is defined) and (mdatp_health.stdout | length > 0)

